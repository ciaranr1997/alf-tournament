<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff Panel - Matches</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #1f2937; color: #f9fafb; }
        .card { background-color: #374151; padding: 2rem; border-radius: 0.5rem; }
        input, select { background-color: #4B5563; color: #F9FAFB; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
    </style>
</head>
<body>
    <div class="container mx-auto p-4">
        <div class="card">
            <h1 class="text-2xl font-bold mb-4">Create Match</h1>
            <form id="createMatchupForm" class="mt-4">
                <div class="mb-4">
                    <label for="team1" class="block mb-2">Team 1</label>
                    <select class="w-full p-2 rounded" id="team1" required></select>
                </div>
                <div class="mb-4">
                    <label for="team2" class="block mb-2">Team 2</label>
                    <select class="w-full p-2 rounded" id="team2" required></select>
                </div>
                <div class="mb-4">
                    <label for="bestOf" class="block mb-2">Best Of</label>
                    <select class="w-full p-2 rounded" id="bestOf" required>
                        <option>3</option>
                        <option>5</option>
                        <option>7</option>
                        <option>9</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label for="round" class="block mb-2">Round</label>
                    <select class="w-full p-2 rounded" id="round" required>
                        <option>Round 1</option>
                        <option>Quarterfinals</option>
                        <option>Semifinals</option>
                        <option>Finals</option>
                    </select>
                </div>
                <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded">Create Match</button>
            </form>

            <hr class="my-6 border-gray-600">

            <h2 class="text-2xl font-bold mb-4">Existing Matches</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full">
                    <thead>
                        <tr>
                            <th class="py-2 px-4 border-b border-gray-600 text-left">Status</th>
                            <th class="py-2 px-4 border-b border-gray-600 text-left">Round</th>
                            <th class="py-2 px-4 border-b border-gray-600 text-left">Team 1</th>
                            <th class="py-2 px-4 border-b border-gray-600 text-left">Team 2</th>
                            <th class="py-2 px-4 border-b border-gray-600 text-left">Best Of</th>
                            <th class="py-2 px-4 border-b border-gray-600 text-left">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="matchesTable">
                        <!-- Matches will be dynamically inserted here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="/js/jquery-3.7.1.min.js"></script>
    <script>
        function loadMatches() {
            $.get("/api/matches", function(matches) {
                const matchesTable = $("#matchesTable");
                matchesTable.empty(); // Clear existing rows
                matches.forEach(match => {
                    const activeStatus = match.is_active ? '<span class="bg-green-500 text-white text-xs font-medium mr-2 px-2.5 py-0.5 rounded-full">Active</span>' : '';
                    const rowClass = match.is_active ? 'bg-blue-900/50' : '';
                    const row = `
                        <tr class="${rowClass}">
                            <td class="py-2 px-4 border-b border-gray-600">${activeStatus}</td>
                            <td class="py-2 px-4 border-b border-gray-600">${match.round_name}</td>
                            <td class="py-2 px-4 border-b border-gray-600">${match.team1_name}</td>
                            <td class="py-2 px-4 border-b border-gray-600">${match.team2_name}</td>
                            <td class="py-2 px-4 border-b border-gray-600">${match.format}</td>
                            <td class="py-2 px-4 border-b border-gray-600">
                                <button class="bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-2 rounded text-sm set-active" data-id="${match.match_id}" ${match.is_active ? 'disabled' : ''}>Set Active</button>
                                <a href="/staff/match/${match.match_id}" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-1 px-2 rounded text-sm">Manage</a>
                                <button class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-1 px-2 rounded text-sm start-pick-ban" data-id="${match.match_id}">Picks/Bans</button>
                                <button class="bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-2 rounded text-sm delete-match" data-id="${match.match_id}">Delete</button>
                            </td>
                        </tr>
                    `;
                    matchesTable.append(row);
                });
            });
        }

        $(document).ready(function() {
            // Fetch teams and populate dropdowns
            $.get("/api/teams", function(teams) {
                const team1Select = $("#team1");
                const team2Select = $("#team2");
                teams.forEach(team => {
                    team1Select.append(`<option value="${team.id}">${team.name}</option>`);
                    team2Select.append(`<option value="${team.id}">${team.name}</option>`);
                });
            });

            loadMatches(); // Load matches on page load

            // Handle form submission
            $("#createMatchupForm").submit(function(event) {
                event.preventDefault();
                const match = {
                    team1: $("#team1").val(),
                    team2: $("#team2").val(),
                    bestOf: $("#bestOf").val(),
                    round: $("#round").val()
                };

                $.post("/api/matches", match, function(data) {
                    console.log(data);
                    loadMatches(); // Refresh the matches table
                });
            });

            // Handle "Set Active" button click
            $("#matchesTable").on("click", ".set-active", function() {
                const matchId = $(this).data("id");
                if (confirm("Are you sure you want to set this match as active? All other matches will be deactivated.")) {
                    $.ajax({
                        url: "/api/matches/" + matchId + "/active",
                        type: "PUT",
                        success: function(result) {
                            console.log(result);
                            window.location.href = "/staff/match/" + matchId;
                        },
                        error: function(xhr, status, error) {
                            console.error("Error setting active match:", error);
                            alert("Error: " + xhr.responseJSON.message);
                        }
                    });
                }
            });

            // Handle delete button click
            $("#matchesTable").on("click", ".delete-match", function() {
                const matchId = $(this).data("id");
                if (confirm("Are you sure you want to delete this match?")) {
                    $.ajax({
                        url: "/api/matches/" + matchId,
                        type: "DELETE",
                        success: function(result) {
                            console.log(result);
                            loadMatches(); // Refresh the matches table
                        }
                    });
                }
            });

            // Handle "Picks/Bans" button click
            $("#matchesTable").on("click", ".start-pick-ban", function() {
                const matchId = $(this).data("id");
                if (confirm("Are you sure you want to start the pick/ban process for this match?")) {
                    $.ajax({
                        url: "/api/matches/" + matchId + "/start-pick-ban",
                        type: "POST",
                        success: function(result) {
                            console.log(result);
                            alert(result.message);
                        },
                        error: function(xhr, status, error) {
                            console.error("Error starting pick/ban:", error);
                            alert("Error: " + xhr.responseJSON.message);
                        }
                    });
                }
            });
        });
    </script>
</body>
</html>