<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Overlay Editor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet" />
    <style>
        body { background-color: #111827; color: #f9fafb; }
        #editor-container {
            position: relative;
            width: 1920px;
            height: 1080px;
            background-color: #000;
            background-image: linear-gradient(45deg, #1f2937 25%, transparent 25%), linear-gradient(-45deg, #1f2937 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #1f2937 75%), linear-gradient(-45deg, transparent 75%, #1f2937 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            border: 1px solid #374151;
            transform-origin: top left;
        }
        .overlay-element {
            position: absolute;
            border: 2px dashed transparent;
            padding: 5px;
            box-sizing: border-box;
            cursor: move;
        }
        .overlay-element:hover, .overlay-element.selected {
            border-color: #4f46e5;
        }
        .resizer {
            width: 10px;
            height: 10px;
            background: #4f46e5;
            position: absolute;
            right: -5px;
            bottom: -5px;
            cursor: se-resize;
        }
        .form-input {
            background-color: #374151;
            border: 1px solid #4b5563;
            color: white;
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
            width: 100%;
        }
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 600;
            transition: background-color 0.2s;
            cursor: pointer;
        }
        .btn-primary { background-color: #4f46e5; color: white; }
        .btn-primary:hover { background-color: #4338ca; }
    </style>
</head>
<body class="flex h-screen">

    <div id="main-content" class="flex-1 flex flex-col overflow-hidden">
        <div class="bg-gray-800 p-2 flex justify-between items-center">
            <h1 class="text-xl font-bold">Overlay Editor</h1>
            <div class="flex items-center space-x-2">
                <label for="zoom-slider">Zoom</label>
                <input type="range" id="zoom-slider" min="0.1" max="1" value="0.5" step="0.01" class="w-48">
            </div>
        </div>
        <div id="editor-viewport" class="flex-1 overflow-auto p-4">
            <div id="editor-container">
                <!-- Elements will be rendered here -->
            </div>
        </div>
    </div>

    <div id="sidebar" class="w-80 bg-gray-900 p-4 overflow-y-auto">
        <h2 class="text-lg font-bold mb-4">Controls</h2>
        <div class="space-y-2 mb-6">
            <button id="add-text-btn" class="btn btn-primary w-full">Add Text</button>
            <button id="add-image-btn" class="btn btn-primary w-full">Add Image</button>
        </div>

        <div id="element-properties" class="hidden">
            <h3 class="text-md font-bold mb-2">Element Properties</h3>
            <form id="properties-form">
                <input type="hidden" id="element-id-input">
                <div class="mb-2">
                    <label for="content-input" class="text-sm">Content</label>
                    <textarea id="content-input" class="form-input" rows="3"></textarea>
                </div>
                <div class="grid grid-cols-2 gap-2 mb-2">
                    <div><label for="pos-x-input" class="text-sm">X</label><input type="number" id="pos-x-input" class="form-input"></div>
                    <div><label for="pos-y-input" class="text-sm">Y</label><input type="number" id="pos-y-input" class="form-input"></div>
                </div>
                <div class="grid grid-cols-2 gap-2 mb-2">
                    <div><label for="width-input" class="text-sm">Width</label><input type="number" id="width-input" class="form-input"></div>
                    <div><label for="height-input" class="text-sm">Height</label><input type="number" id="height-input" class="form-input"></div>
                </div>
                <div class="mb-2">
                    <label for="style-input" class="text-sm">Style (JSON)</label>
                    <textarea id="style-input" class="form-input" rows="5"></textarea>
                </div>
                <button type="button" id="delete-element-btn" class="btn btn-danger w-full mt-4">Delete Element</button>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const editorContainer = document.getElementById('editor-container');
            const zoomSlider = document.getElementById('zoom-slider');
            const addTextBtn = document.getElementById('add-text-btn');
            const addImageBtn = document.getElementById('add-image-btn');
            const propertiesPanel = document.getElementById('element-properties');
            const propertiesForm = document.getElementById('properties-form');
            const deleteElementBtn = document.getElementById('delete-element-btn');

            const overlayId = window.location.pathname.split('/').pop();
            let selectedElement = null;

            function applyZoom() {
                editorContainer.style.transform = `scale(${zoomSlider.value})`;
            }
            zoomSlider.addEventListener('input', applyZoom);
            applyZoom();

            async function fetchElements() {
                const response = await fetch(`/api/admin/overlays/${overlayId}/elements`);
                const elements = await response.json();
                editorContainer.innerHTML = '';
                elements.forEach(createElement);
            }

            function createElement(elementData) {
                const el = document.createElement('div');
                el.className = 'overlay-element';
                el.dataset.id = elementData.element_id;
                el.style.left = elementData.position_x + 'px';
                el.style.top = elementData.position_y + 'px';
                el.style.width = elementData.width + 'px';
                el.style.height = elementData.height + 'px';

                if (elementData.type === 'text') {
                    el.textContent = elementData.content;
                } else if (elementData.type === 'image') {
                    el.style.backgroundImage = `url(${elementData.content})`;
                    el.style.backgroundSize = 'cover';
                }
                
                if (elementData.style) {
                    Object.assign(el.style, elementData.style);
                }

                const resizer = document.createElement('div');
                resizer.className = 'resizer';
                el.appendChild(resizer);

                editorContainer.appendChild(el);
                makeInteractable(el);
            }

            function makeInteractable(el) {
                interact(el)
                    .draggable({
                        listeners: {
                            move(event) {
                                const target = event.target;
                                const x = (parseFloat(target.getAttribute('data-x')) || 0) + event.dx;
                                const y = (parseFloat(target.getAttribute('data-y')) || 0) + event.dy;

                                target.style.transform = `translate(${x}px, ${y}px)`;
                                target.setAttribute('data-x', x);
                                target.setAttribute('data-y', y);
                            },
                            end(event) {
                                const target = event.target;
                                const newX = parseInt(target.style.left) + parseFloat(target.getAttribute('data-x') || 0);
                                const newY = parseInt(target.style.top) + parseFloat(target.getAttribute('data-y') || 0);
                                target.style.left = newX + 'px';
                                target.style.top = newY + 'px';
                                target.style.transform = '';
                                target.removeAttribute('data-x');
                                target.removeAttribute('data-y');
                                updateElement(target.dataset.id, { position_x: newX, position_y: newY });
                                if (selectedElement === target) {
                                    updatePropertiesPanel(target);
                                }
                            }
                        }
                    })
                    .resizable({
                        edges: { left: false, right: true, bottom: true, top: false },
                        listeners: {
                            move(event) {
                                const target = event.target;
                                target.style.width = event.rect.width + 'px';
                                target.style.height = event.rect.height + 'px';
                            },
                            end(event) {
                                const target = event.target;
                                updateElement(target.dataset.id, { width: parseInt(target.style.width), height: parseInt(target.style.height) });
                                if (selectedElement === target) {
                                    updatePropertiesPanel(target);
                                }
                            }
                        }
                    })
                    .on('tap', (event) => {
                        selectElement(event.currentTarget);
                    });
            }

            function selectElement(el) {
                if (selectedElement) {
                    selectedElement.classList.remove('selected');
                }
                selectedElement = el;
                selectedElement.classList.add('selected');
                propertiesPanel.classList.remove('hidden');
                updatePropertiesPanel(el);
            }

            function updatePropertiesPanel(el) {
                document.getElementById('element-id-input').value = el.dataset.id;
                document.getElementById('pos-x-input').value = parseInt(el.style.left);
                document.getElementById('pos-y-input').value = parseInt(el.style.top);
                document.getElementById('width-input').value = parseInt(el.style.width);
                document.getElementById('height-input').value = parseInt(el.style.height);
                // This is a simplification. A real editor would parse this better.
                document.getElementById('content-input').value = el.textContent || el.style.backgroundImage.slice(4, -1).replace(/"/g, "");
                
                const style = {};
                for(let i = 0; i < el.style.length; i++) {
                    const prop = el.style[i];
                    if (['left', 'top', 'width', 'height', 'position', 'border', 'padding', 'box-sizing', 'cursor', 'transform', 'background-image', 'background-size'].includes(prop)) continue;
                    style[prop] = el.style[prop];
                }
                document.getElementById('style-input').value = JSON.stringify(style, null, 2);
            }

            async function addElement(type) {
                const content = type === 'text' ? 'New Text' : '/public/shield-icon.svg';
                const response = await fetch(`/api/admin/overlays/${overlayId}/elements`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ type, content, position_x: 100, position_y: 100, width: 200, height: 50 })
                });
                const newElement = await response.json();
                createElement(newElement);
            }

            addTextBtn.addEventListener('click', () => addElement('text'));
            addImageBtn.addEventListener('click', () => addElement('image'));

            async function updateElement(elementId, data) {
                await fetch(`/api/admin/overlays/${overlayId}/elements/${elementId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
            }
            
            propertiesForm.addEventListener('change', (e) => {
                if (!selectedElement) return;
                const elementId = document.getElementById('element-id-input').value;
                const data = {
                    position_x: document.getElementById('pos-x-input').value,
                    position_y: document.getElementById('pos-y-input').value,
                    width: document.getElementById('width-input').value,
                    height: document.getElementById('height-input').value,
                    content: document.getElementById('content-input').value,
                    style: JSON.parse(document.getElementById('style-input').value)
                };
                updateElement(elementId, data).then(() => fetchElements());
            });

            deleteElementBtn.addEventListener('click', async () => {
                if (!selectedElement) return;
                const elementId = selectedElement.dataset.id;
                if (confirm('Delete this element?')) {
                    await fetch(`/api/admin/overlays/${overlayId}/elements/${elementId}`, { method: 'DELETE' });
                    selectedElement.remove();
                    propertiesPanel.classList.add('hidden');
                    selectedElement = null;
                }
            });

            fetchElements();
        });
    </script>
</body>
</html>
